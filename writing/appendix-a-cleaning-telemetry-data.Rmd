---
title: \Large Predicting how climate change will affect how and where terrestrial mammals will move in British Columbia, Canada
subtitle: "Appendix A: Cleaning telemetry data"
author:
  - name: Stefano Mezzini
    email: stefano.mezzini@ubc.ca
    institute: [braes, biol]
  - name: Chris H. Fleming
    institute: [ucf, smith]
  - name: Siobhan Darlington
    institute: [braes, biol]
  - name: Adam T. Ford
    institute: [braes, biol]
  - name: Karen E. Hodges
    institute: [braes, biol]
  - name: Kirk Safford
    institute: bcp
  - name: Robert Serrouya
    institute: [braes, biol, biodiv]
  - name: Michael J. Noonan
    email: michael.noonan@ubc.ca
    institute: [braes, biol, cmps]
institute:
  - braes: Okanagan Institute for Biodiversity, Resilience, and Ecosystem Services, The University of British Columbia Okanagan, Kelowna, British Columbia, Canada.
  - biol: Department of Biology, The University of British Columbia Okanagan, Kelowna, British Columbia, Canada.
  - ucf: Department of Biology, University of Central Florida, Orlando, Florida 32816, United States.
  - smith: Smithsonian Conservation Biology Institute, National Zoological Park, 1500 Remount Rd., Front Royal, VA 22630, United States.
  - bcp: BC Parks
  - biodiv: Wildlife Science Centre, Biodiversity Pathways, University of British Columbia Okanagan, Revelstoke, British Columbia, Canada.
  - cmps: Department of Computer Science, Math, Physics, and Statistics, The University of British Columbia Okanagan, Kelowna, British Columbia, Canada.
bibliography: 'bc-mammals-temperature.bib'
csl: 'movement-ecology.csl'
# csl: 'nature.csl'
fontsize: 12pt
# indent: true
header-includes:
    - \renewcommand{\figurename}{Figure S\!\!} # for "Figure Ax.
    - \usepackage{setspace}\doublespacing # for double-spaced text
    - \usepackage{indentfirst} # for indenting first line of each paragraph
    - \usepackage[small]{titlesec} # for smaller font for headings
    - \usepackage{caption} # for more customization of captions
    - \captionsetup[figure]{font=scriptsize, aboveskip=4pt, belowskip=-15pt}
    - \usepackage{hanging} # for hanging indents in references
    - \usepackage{float} # to use fig.pos="H"
subparagraph: true # needed for \usepackage[small]{titlesec}
urlcolor: cyan
output:
  bookdown::pdf_document2:
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
    toc: false
    number_sections: true
---

```{r setup, include=FALSE}
# set chunk defaults
knitr::opts_chunk$set(echo = TRUE, out.width = '100%',
                      fig.align = 'center', cache = TRUE, warning = FALSE,
                      message = FALSE,
                      root.dir = 'H:/GitHub/bc-mammals-temperature')
```

\clearpage

In this appendix, we illustrate the cleaning procedure for the telemetry data. For the sake of brevity, we only show the code and outputs for *Canis lupus*; the full script is available at  [https://github.com/QuantitativeEcologyLab/bc-mammals-temperature/blob/main/analysis/02-remove-outliers.R](https://github.com/QuantitativeEcologyLab/bc-mammals-temperature/blob/main/analysis/02-remove-outliers.R). We suggest looking at the script since this appendix does not include the interactive maps that are generated by `plot_adj(..., map = TRUE)`. The interactive maps often show linear features (e.g., roads) and other geographic features (e.g., mountain ridges, rivers) that were useful to see during the data cleaning. Therefore, we have left the function calls in the document for completeness, but we have commented them out to prevent them from being executed. Below is an example of a map with some locations for wolf BW008, as generated by running\newline`plot_adj('BW008', max_speed = 3.5, map = TRUE)`.

\singlespacing

```{r map-example, echo=FALSE, out.height='40%'}
knitr::include_graphics(path = 'H:/GitHub/bc-mammals-temperature/figures/BW008-map-example.jpg',
                        rel_path = FALSE)
```

We start by attaching the necessary packages and sourcing some custom functions. The custom functions are all available on GitHub in the `functions` folder of the repository located at [https://github.com/QuantitativeEcologyLab/bc-mammals-temperature](https://github.com/QuantitativeEcologyLab/bc-mammals-temperature).

\clearpage

\small

```{r packages}
library('dplyr')     # for data wrangling (mutate(), %>%, etc.)
library('tidyr')     # for data wrangling (nest(), unnest(), pivot_*, etc.)
library('purrr')     # for functional programming (map_***(), etc.)
library('ctmm')      # for movement models
library('lubridate') # for working with dates
library('mapview')   # for interactive maps
library('ggplot2')   # for fancy plots
theme_set(theme_bw())

# source custom functions
source('functions/outlier_plots.R') # to plot outlier diagnostic plots
source('functions/check_animal.R') # to run diagnostic plots
source('functions/plot_adj.R') # to plot n adjacent locations
source('functions/flag_outlier.R') # to mark outliers
source('functions/remove_outlier_flags.R') # to start over with an animal
```

\normalsize

Before cleaning the telemetry data, we do some basic checks:

\small

```{r checks}
# dataset checks ----
# some NA timestamps (not enough to make a difference)
readRDS('data/tracking-data/all-tracking-data-not-cleaned.rds') %>%
  filter(is.na(timestamp)) %>%
  group_by(dataset_name) %>%
  summarize(n = n())

# ensure all only have one column of HDOP
readRDS('data/tracking-data/all-tracking-data-not-cleaned.rds') %>%
  filter(! is.na(timestamp)) %>%
  mutate(outlier = if_else(outlier, 1, 0)) %>%
  filter(! is.na(hdop) + ! is.na(HDOP) > 1) %>%
  nrow()
```

<!-- to avoid splitting code chunk -->
\clearpage

```{r checks-2}
# should only have one column of DOP
readRDS('data/tracking-data/all-tracking-data-not-cleaned.rds') %>%
  filter(! is.na(timestamp)) %>%
  mutate(outlier = if_else(outlier, 1, 0)) %>%
  filter(! is.na(DOP) + ! is.na(gps.dop) > 1) %>%
  nrow()
```

\normalsize

We can now import the data...

\small

```{r import-data}
# import the full dataset ----
# import the dataset after dropping NAs
d <- readRDS('data/tracking-data/all-tracking-data-not-cleaned.rds') %>%
  filter(! is.na(timestamp)) %>%
  mutate(hdop = if_else(is.na(hdop), HDOP, hdop), # merge error columns
         dop = if_else(is.na(DOP), gps.dop, DOP),
         original_outliers = outlier,
         outlier = if_else(outlier, 1, 0)) %>% # make numeric
  select(! c(HDOP, DOP, gps.dop)) %>% # remove duplicate columns
  relocate(dop, .after = pdop) %>%
  nest(tel = ! c(species, dataset_name, animal))
d # nested tibble of tracking datasets
```

\normalsize

... and do some last few check before cleaning.

\small

```{r final-checks}
# ensure animal IDs are unique
sum(duplicated(d$animal))
```

\clearpage

```{r final-checks2}
# check which species have DOP values
d %>%
  unnest(tel) %>%
  group_by(species) %>%
  summarise(across(c(dop, hdop, pdop), ~ sum(.x, na.rm = TRUE))) %>%
  mutate(has_dop = dop + hdop + pdop > 0) %>%
  arrange(desc(has_dop))

#' see`finite`: some SM caribou have different values for hdop and dop
#' other datasets are ok
d %>%
  unnest(tel) %>%
  mutate(has_hdop = ! is.na(hdop),
         has_dop = ! is.na(dop),
         has_pdop = ! is.na(pdop)) %>%
  group_by(dataset_name, has_hdop, has_dop, has_pdop) %>%
  summarise(hdop = mean(hdop, na.rm = TRUE),
            pdop = mean(pdop, na.rm = TRUE),
            dop = mean(dop, na.rm = TRUE)) %>%
  mutate(finite = map_int(1:n(),
                          ~ sum(! is.nan(c(hdop[.x], pdop[.x], dop[.x])))))

d %>%
  filter(dataset_name == 'Rangifer_tarandus_southern_mountain') %>%
  unnest(tel) %>%
  filter(! is.na(hdop) & ! is.na(dop)) %>%
  plot(hdop ~ dop, ., main = paste('n =', nrow(.)))
abline(a = 0, b = 1, col = 'red', lwd = 2)
```

\normalsize

Now that we have organized the full telemetry dataset, we can start cleaning the data.

\clearpage

\small

```{r canis-lupus, fig.pos='!H', fig.dim=c(10, 12)}
# BW008
out <- check_animal('BW008')
plot_adj('BW008', max_speed = 3.5)
# plot_adj('BW008', max_speed = 3.5, map = TRUE)
plot_adj('BW008', max_angle = 178, max_speed = 1) # using a linear feature
plot_adj('BW008', max_angle = 90, max_speed = 2) # realistic movement
plot_adj('BW008', max_angle = 170, max_speed = 0.5) # fine sampling
```

\clearpage

```{r canis-lupus-2, fig.pos='!H', fig.dim=c(10, 12)}
out[out$angle > 170 & out$speed > 0.5, ] # 15-minute sampling
```

\clearpage

```{r canis-lupus-3, fig.pos='!H', fig.dim=c(10, 12)}
# BW009
out <- check_animal('BW009')
plot_adj('BW009', max_angle = 179, max_speed = 1) # potential outlier
plot_adj('BW009', max_angle = 179.7, max_speed = 1, n_adj=200) # uses path
plot_adj('BW009', max_angle = 175, max_speed = 1, n_adj = 12) # ok
plot_adj('BW009', max_angle = 170, min_angle = 175, max_speed = 1,
         n_adj = 20) # ok
plot_adj('BW009', max_angle = 170, max_speed = 0.5) # reasonable

# BW010
out <- check_animal('BW010')
plot_adj('BW010', max_speed = 3.5) # ok
plot_adj('BW010', max_speed = 1, max_angle = 170) # ok
plot_adj('BW010', max_speed = 2, max_angle = 135) # ok

# BW012
out <- check_animal('BW012')
plot_adj('BW012', max_speed = 3)
plot_adj('BW012', max_speed = 1, max_angle = 170)
```


```{r canis-lupus-4, fig.pos='!H', fig.dim=c(5, 6)}
# location is ok
tel <- as.telemetry(d$tel[[which(d$animal == 'BW012')]])
i <- which(out$speed > 2 & out$angle > 170)
plot(tel, error = FALSE, type = 'l', xlim = c(-2600, 0),
     ylim = c(300, 2200), col = 'black')
plot(tel[i + -10:10, ],
     error = FALSE, type = 'l', col = 'blue', lwd = 2, add = TRUE)
plot(tel[i, ],
     error = FALSE, col = 'blue', pch = 19, add = TRUE)
plot(tel, add = TRUE)
rm(tel, i)
```


```{r canis-lupus-5, fig.pos='!H', fig.dim=c(10, 12)}
# BW013
out <- check_animal('BW013')
plot_adj('BW013', max_speed = 1, max_angle = 170) # uses linear features

# BW014 has a clear GPS error
out <- check_animal('BW014')
plot_adj('BW014', max_speed = 4)
flag_outlier(id = 'BW014', max_speed = 4, value = 1)
out <- check_animal('BW014')
plot_adj('BW014', max_speed = 2) # ok
plot_adj('BW014', max_speed = 0.5, min_speed = 0.6, max_angle = 170,
         n_adj = 30) # seems near a linear feature
# plot_adj('BW014', max_speed = 0.5, min_speed = 0.6, max_angle = 170,
#          map = TRUE) # moving along a river

# B027
out <- check_animal('BW027')
plot_adj('BW027', max_speed = 3, max_angle = 90) # not problematic

# BW028
out <- check_animal('BW028')
plot_adj('BW028', max_speed = 3) # not problematic

# B029
out <- check_animal('BW029')
plot_adj('BW029', max_speed = 2, max_angle = 175) # need a finer scale
plot_adj('BW029', max_speed = 2, max_angle = 175, n_adj = 2) # ok

# B031
out <- check_animal('BW031')
plot_adj('BW031', max_speed = 1, max_angle = 170) # need a finer scale
plot_adj('BW031', max_speed = 1, max_angle = 170, n_adj = 5) # ok

# B033: sharp and fast turns are near linear features
out <- check_animal('BW033')
plot_adj('BW033', max_speed = 1.5, max_angle = 90, n_adj = 5)

# BW044nex
out <- check_animal('BW044nex')
plot_adj('BW044nex', max_speed = 1, max_angle = 170)

# BW046nex
out <- check_animal('BW046nex')
plot_adj('BW046nex', max_speed = 1, max_angle = 175, min_speed = 3) # ok
plot_adj('BW046nex', max_speed = 1, min_speed = 3, # problematic
         max_angle = 135, min_angle = 175, reset_layout = FALSE)
i <- which(out$speed > 1 & out$speed < 3 & # likely hunting
             out$angle > 135 & out$angle < 175) + 0:5
points(location.lat ~ location.long,
       d$tel[[which(d$animal == 'BW046nex')]][i, ], col = 'blue', cex = 2)
d$tel[[which(d$animal == 'BW046nex')]][i, 'outlier'] <- 1
plot_adj('BW046nex', max_speed = 1, max_angle = 170) # ok
```
